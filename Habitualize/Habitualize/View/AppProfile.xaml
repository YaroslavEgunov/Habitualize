<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Habitualize.View.AppProfile">
    
    <ScrollView VerticalScrollBarVisibility="Never" 
                HorizontalScrollBarVisibility="Never">
        <StackLayout Padding="20">

            <Border Grid.Row="0" 
                    Style="{StaticResource ProfileStyleSqr}">
                <Grid ColumnDefinitions="*,Auto" 
                      VerticalOptions="Center">
                    <!-- Текст -->
                    <Label Grid.Column="0"
                           HorizontalOptions="Start" 
                           VerticalOptions="Center" 
                           LineHeight="1">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Hi, " 
                                      TextColor="White" 
                                      FontAttributes="Bold" 
                                      FontSize="28"/>
                                <Span Text="{Binding Username, 
                                            StringFormat='{0}!'}" 
                                      TextColor="White" 
                                      FontAttributes="Bold"
                                      FontSize="28"/>
                                <Span Text="&#x0a;"/>
                                <Span Text="&#x0a;"/>
                                <Span Text="What are you doing next?" 
                                      TextColor="White" 
                                      FontAttributes="Bold"
                                      FontSize="16"/>   
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <!-- Изображение -->
                    <Image Grid.Column="1"
                           x:Name="AvatarImage"
                           Source="{Binding AvatarImageSource, 
                                  FallbackValue='default_avatar.jpg'}" 
                           Aspect="AspectFill"
                           HeightRequest="100"
                           WidthRequest="100"
                           HorizontalOptions="End">
                        <Image.Clip>
                            <RoundRectangleGeometry CornerRadius="15"
                                                    Rect="40,0,100,100" />
                        </Image.Clip>
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAvatarTapped" />
                        </Image.GestureRecognizers>
                    </Image>
                </Grid>
            </Border>

            <!-- Краткая биография -->
            <Editor Style="{StaticResource ProfileEditorStyle}"
            x:Name="BioEditor"
            Text="{Binding Bio}"
            Focused="OnBioEditorFocused"
            Unfocused="OnBioEditorUnfocused"
            TextChanged="OnBioTextChanged"/>

            <Grid ColumnDefinitions="*,Auto" Margin="0,20,0,10">
                <!-- Заголовок "Friends" -->
                <Label Text="Friends"
                       FontSize="18"
                       TextColor="Black"
                       FontAttributes="Bold"
                       VerticalOptions="Center"
                       HorizontalOptions="Start" />

                <!-- Ссылка "See All" -->
                <Picker Grid.Column="1"
                        Title="See All"
                        ItemsSource="{Binding Friends}"
                        ItemDisplayBinding="{Binding Name}"
                        VerticalOptions="Center"
                        HorizontalOptions="End"
                        SelectedIndexChanged="OnFriendSelected" />
            </Grid>

            <!-- Список друзей -->
            <CollectionView ItemsSource="{Binding Friends}"
                            SelectionMode="None"
                            VerticalOptions="FillAndExpand">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="10" 
                              ColumnDefinitions="Auto,*,Auto" 
                              RowDefinitions="Auto">
                            <!-- Аватар друга -->
                            <Image Source="{Binding Avatar}"
                                   HeightRequest="50"
                                   WidthRequest="50"
                                   Aspect="AspectFill"> 
                                <Image.Clip>
                                    <EllipseGeometry Center="25,25" RadiusX="25" RadiusY="25" />
                                </Image.Clip>
                            </Image>

                            <!-- Имя друга -->
                            <Label Grid.Column="1"
                                   Text="{Binding Name}"
                                   FontSize="16"
                                   TextColor="black"
                                   VerticalOptions="Center"
                                   Margin="10,0,0,0" /> 

                            <!-- Кнопка действия -->
                            <Button Grid.Column="2"
                                    Text="Message"
                                    FontSize="14"
                                    VerticalOptions="Center"
                                    Command="{Binding MessageCommand}"
                                    CommandParameter="{Binding .}" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </StackLayout>
    </ScrollView>
</ContentView>
